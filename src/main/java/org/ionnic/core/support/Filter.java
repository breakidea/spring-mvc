package org.ionnic.core.support;import java.io.IOException;import java.io.UnsupportedEncodingException;import java.util.Locale;import javax.servlet.FilterChain;import javax.servlet.ServletException;import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpServletResponse;import org.apache.commons.logging.Log;import org.apache.commons.logging.LogFactory;import org.ionnic.core.support.layer.FilterProxyConfig;import org.ionnic.core.support.layer.HttpMethodRequestWrapper;import org.springframework.util.StringUtils;import org.springframework.web.filter.OncePerRequestFilter;public class Filter extends OncePerRequestFilter {	protected final Log logger = LogFactory.getLog(Filter.class);	private FilterProxyConfig config;	/**	 * @param request	 * @param response	 * @throws UnsupportedEncodingException	 */	private void doCharsetEncoding(HttpServletRequest request, HttpServletResponse response) throws UnsupportedEncodingException {		if (config.getEncoding() != null && (config.isForceEncoding() || request.getCharacterEncoding() == null)) {			request.setCharacterEncoding(config.getEncoding());			if (config.isForceEncoding()) {				response.setCharacterEncoding(config.getEncoding());			}			if (logger.isDebugEnabled()) {				logger.debug("set charsetEncoding as " + config.getEncoding() + "request is " + request.getRequestURI());			}		}	}	@Override	protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException,	        IOException {		doCharsetEncoding(request, response);		doHiddenHttpMethod(request, response, filterChain);	}	/**	 * @param request	 * @param response	 * @param filterChain	 * @throws ServletException	 * @throws IOException	 */	private void doHiddenHttpMethod(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException,	        IOException {		if (!config.isIgnoreHiddenMethod()) {			String paramValue = request.getParameter(config.getHiddenMethodParam());			if ("POST".equals(request.getMethod()) && StringUtils.hasLength(paramValue)) {				String method = paramValue.toUpperCase(Locale.ENGLISH);				HttpServletRequest wrapper = new HttpMethodRequestWrapper(request, method);				filterChain.doFilter(wrapper, response);				if (logger.isDebugEnabled()) {					logger.debug("set HiddenHttpMethod to " + method + ", request is " + request.getRequestURI());				}			} else {				filterChain.doFilter(request, response);			}		} else {			filterChain.doFilter(request, response);		}	}	public void setConfig(FilterProxyConfig config) {		this.config = config;	}}